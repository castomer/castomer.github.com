<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.82.0"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta property="og:title" content="使用简单shell实现服务进程的守护"><meta name=author content="Dongfang Qu"><meta name=keywords content="bash,ops"><meta name=description content="有这样一种需求：假如服务(模块)进程异常退出了，自动重启它。
社区有许多成熟的方案，常用的有以下几个：
 daemontools 老牌supervise，c/c++社区 monit ruby社区用的多，附带比较多监控功能 commons-daemon java社区常用 akuma …"><meta property="og:title" content="使用简单shell实现服务进程的守护"><meta property="og:description" content="有这样一种需求：假如服务(模块)进程异常退出了，自动重启它。
社区有许多成熟的方案，常用的有以下几个：
 daemontools 老牌supervise，c/c++社区 monit ruby社区用的多，附带比较多监控功能 commons-daemon java社区常用 akuma java社区小众lib   虽然以上方案都不算复杂，我还是想使用更简单的方式把这个问题解决了。
下面是从之前同事那里抄过来了一个简单方案：
#!/bin/bash # control # qudongfang@gmail.com WORKSPACE=$(cd $(dirname $0)/../; pwd) cd ${WORKSPACE} readonly app=server readonly conf=&#34;conf/${app}.conf&#34; readonly logPath=&#34;log&#34; readonly logfile=&#34;${logPath}/stdout.log&#34; readonly ULIMIT_RESIDENT_SET_SIZE=1000000 readonly ULIMIT_ADDRESS_SPACE=4000000 readonly ULIMIT_CORE_FILE_SIZE=1000000 readonly ULIMIT_FD_SIZE=1024 readonly SUPERVISE_NAME=&#34;supervise.${app}&#34; # 1 = running # 0 = not running function check_running(){ # 使用文件所检测进程是否已经启动 # 此处将来单独写篇文章来介绍 flock -x -n ${WORKSPACE}/${conf} -c &#34;&#34; return $? } function start(){ cd ${WORKSPACE} check_running if [ $?"><meta property="og:type" content="article"><meta property="og:url" content="https://www.concurrent.work/2016/03/12/simple-process-supervision-using-shell/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-03-12T00:00:00+00:00"><meta property="article:modified_time" content="2016-03-12T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="使用简单shell实现服务进程的守护"><meta name=twitter:description content="有这样一种需求：假如服务(模块)进程异常退出了，自动重启它。
社区有许多成熟的方案，常用的有以下几个：
 daemontools 老牌supervise，c/c++社区 monit ruby社区用的多，附带比较多监控功能 commons-daemon java社区常用 akuma java社区小众lib   虽然以上方案都不算复杂，我还是想使用更简单的方式把这个问题解决了。
下面是从之前同事那里抄过来了一个简单方案：
#!/bin/bash # control # qudongfang@gmail.com WORKSPACE=$(cd $(dirname $0)/../; pwd) cd ${WORKSPACE} readonly app=server readonly conf=&#34;conf/${app}.conf&#34; readonly logPath=&#34;log&#34; readonly logfile=&#34;${logPath}/stdout.log&#34; readonly ULIMIT_RESIDENT_SET_SIZE=1000000 readonly ULIMIT_ADDRESS_SPACE=4000000 readonly ULIMIT_CORE_FILE_SIZE=1000000 readonly ULIMIT_FD_SIZE=1024 readonly SUPERVISE_NAME=&#34;supervise.${app}&#34; # 1 = running # 0 = not running function check_running(){ # 使用文件所检测进程是否已经启动 # 此处将来单独写篇文章来介绍 flock -x -n ${WORKSPACE}/${conf} -c &#34;&#34; return $? } function start(){ cd ${WORKSPACE} check_running if [ $?"><link rel=stylesheet type=text/css media=screen href=/css/normalize.css><link rel=stylesheet type=text/css media=screen href=/css/main.css><link rel=stylesheet type=text/css media=screen href=/css/all.css><link rel=stylesheet href=/css/katex.min.css crossorigin=anonymous><script defer src=/js/katex.min.js integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz crossorigin=anonymous></script><script defer src=/js/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><title>使用简单shell实现服务进程的守护 | Concurrent Work</title></head><body><header><div id=titletext><h2 id=title><a href=https://www.concurrent.work>Concurrent Work</a></h2></div><div id=title-description><p id=subtitle>Rambling of a coder who craves for knowledge and understanding of the world.</p><div id=social><nav><ul><li><a href=https://github.com/qudongfang><i title=Github class="icons fab fa-github"></i></a></li><li><a href=https://www.linkedin.com/in/qudongfang/><i title=LinkedIn class="icons fab fa-linkedin"></i></a></li><li><a href=https://twitter.com/qudongfang><i title=Twitter class="icons fab fa-twitter"></i></a></li></ul></nav></div></div><div id=mainmenu><nav><ul><li><a href=/posts>All Posts</a></li><li><a href=/tags>Tags</a></li><li><a href=/about>About</a></li></ul></nav></div></header><main><div class=post><div class=author><p>Written by Dongfang Qu</p></div><div class=post-header><div class=meta><div class=date><span class=day>12</span>
<span class=rest>Mar 2016</span></div></div><div class=matter><h1 class=title>使用简单shell实现服务进程的守护</h1></div></div><div class=markdown><p>有这样一种需求：假如服务(模块)进程异常退出了，自动重启它。</p><p>社区有许多成熟的方案，常用的有以下几个：</p><ul><li><a href=https://cr.yp.to/daemontools.html target=_blank>daemontools</a> 老牌supervise，c/c++社区</li><li><a href=https://mmonit.com/monit/ target=_blank>monit</a> ruby社区用的多，附带比较多监控功能</li><li><a href=http://commons.apache.org/proper/commons-daemon/ target=_blank>commons-daemon</a> java社区常用</li><li><a href=http://akuma.kohsuke.org/ target=_blank>akuma</a> java社区小众lib</li></ul><hr><p>虽然以上方案都不算复杂，我还是想使用更简单的方式把这个问题解决了。</p><p>下面是从之前同事那里抄过来了一个简单方案：</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#579>#!/bin/bash
</span><span style=color:#579></span><span style=color:#888># control</span>
<span style=color:#888># qudongfang@gmail.com</span>

<span style=color:#963>WORKSPACE</span><span style=color:#333>=</span><span style=color:#080;font-weight:700>$(</span><span style=color:#007020>cd</span> <span style=color:#080;font-weight:700>$(</span>dirname <span style=color:#963>$0</span><span style=color:#080;font-weight:700>)</span>/../; <span style=color:#007020>pwd</span><span style=color:#080;font-weight:700>)</span>
<span style=color:#007020>cd</span> <span style=background-color:#eee>${</span><span style=color:#963>WORKSPACE</span><span style=background-color:#eee>}</span>

<span style=color:#007020>readonly</span> <span style=color:#963>app</span><span style=color:#333>=</span>server

<span style=color:#007020>readonly</span> <span style=color:#963>conf</span><span style=color:#333>=</span><span style=background-color:#fff0f0>&#34;conf/</span><span style=background-color:#eee>${</span><span style=color:#963>app</span><span style=background-color:#eee>}</span><span style=background-color:#fff0f0>.conf&#34;</span>
<span style=color:#007020>readonly</span> <span style=color:#963>logPath</span><span style=color:#333>=</span><span style=background-color:#fff0f0>&#34;log&#34;</span>
<span style=color:#007020>readonly</span> <span style=color:#963>logfile</span><span style=color:#333>=</span><span style=background-color:#fff0f0>&#34;</span><span style=background-color:#eee>${</span><span style=color:#963>logPath</span><span style=background-color:#eee>}</span><span style=background-color:#fff0f0>/stdout.log&#34;</span>

<span style=color:#007020>readonly</span> <span style=color:#963>ULIMIT_RESIDENT_SET_SIZE</span><span style=color:#333>=</span><span style=color:#60e;font-weight:700>1000000</span>
<span style=color:#007020>readonly</span> <span style=color:#963>ULIMIT_ADDRESS_SPACE</span><span style=color:#333>=</span><span style=color:#60e;font-weight:700>4000000</span>
<span style=color:#007020>readonly</span> <span style=color:#963>ULIMIT_CORE_FILE_SIZE</span><span style=color:#333>=</span><span style=color:#60e;font-weight:700>1000000</span>
<span style=color:#007020>readonly</span> <span style=color:#963>ULIMIT_FD_SIZE</span><span style=color:#333>=</span><span style=color:#60e;font-weight:700>1024</span>

<span style=color:#007020>readonly</span> <span style=color:#963>SUPERVISE_NAME</span><span style=color:#333>=</span><span style=background-color:#fff0f0>&#34;supervise.</span><span style=background-color:#eee>${</span><span style=color:#963>app</span><span style=background-color:#eee>}</span><span style=background-color:#fff0f0>&#34;</span>

<span style=color:#888># 1 = running</span>
<span style=color:#888># 0 = not running</span>
<span style=color:#080;font-weight:700>function</span> check_running<span style=color:#333>(){</span>
    <span style=color:#888># 使用文件所检测进程是否已经启动</span>
    <span style=color:#888># 此处将来单独写篇文章来介绍</span>
    flock -x -n <span style=background-color:#eee>${</span><span style=color:#963>WORKSPACE</span><span style=background-color:#eee>}</span>/<span style=background-color:#eee>${</span><span style=color:#963>conf</span><span style=background-color:#eee>}</span> -c <span style=background-color:#fff0f0>&#34;&#34;</span>

    <span style=color:#080;font-weight:700>return</span> <span style=color:#963>$?</span>
<span style=color:#333>}</span>

<span style=color:#080;font-weight:700>function</span> start<span style=color:#333>(){</span>
    <span style=color:#007020>cd</span> <span style=background-color:#eee>${</span><span style=color:#963>WORKSPACE</span><span style=background-color:#eee>}</span>

    check_running
    <span style=color:#080;font-weight:700>if</span> <span style=color:#333>[</span> <span style=color:#963>$?</span> -gt <span style=color:#60e;font-weight:700>0</span> <span style=color:#333>]</span>;<span style=color:#080;font-weight:700>then</span>
        <span style=color:#007020>echo</span> <span style=background-color:#fff0f0>&#34;</span><span style=background-color:#eee>${</span><span style=color:#963>app</span><span style=background-color:#eee>}</span><span style=background-color:#fff0f0> now is running already.&#34;</span>
        <span style=color:#080;font-weight:700>return</span> <span style=color:#60e;font-weight:700>1</span>
    <span style=color:#080;font-weight:700>fi</span>

    <span style=color:#080;font-weight:700>if</span> ! <span style=color:#333>[</span> -f <span style=background-color:#eee>${</span><span style=color:#963>WORKSPACE</span><span style=background-color:#eee>}</span>/<span style=background-color:#eee>${</span><span style=color:#963>conf</span><span style=background-color:#eee>}</span> <span style=color:#333>]</span>;<span style=color:#080;font-weight:700>then</span>
        <span style=color:#007020>echo</span> <span style=background-color:#fff0f0>&#34;Config file </span><span style=background-color:#eee>${</span><span style=color:#963>conf</span><span style=background-color:#eee>}</span><span style=background-color:#fff0f0> doesn&#39;t exist&#34;</span>
        <span style=color:#080;font-weight:700>return</span> <span style=color:#60e;font-weight:700>2</span>
    <span style=color:#080;font-weight:700>fi</span>

    <span style=color:#007020>ulimit</span> -m <span style=background-color:#eee>${</span><span style=color:#963>ULIMIT_RESIDENT_SET_SIZE</span><span style=background-color:#eee>}</span>
    <span style=color:#007020>ulimit</span> -v <span style=background-color:#eee>${</span><span style=color:#963>ULIMIT_ADDRESS_SPACE</span><span style=background-color:#eee>}</span>
    <span style=color:#007020>ulimit</span> -c <span style=background-color:#eee>${</span><span style=color:#963>ULIMIT_CORE_FILE_SIZE</span><span style=background-color:#eee>}</span>
    <span style=color:#007020>ulimit</span> -n <span style=background-color:#eee>${</span><span style=color:#963>ULIMIT_FD_SIZE</span><span style=background-color:#eee>}</span>

    mkdir -p <span style=background-color:#eee>${</span><span style=color:#963>logPath</span><span style=background-color:#eee>}</span>
    mv <span style=background-color:#eee>${</span><span style=color:#963>logfile</span><span style=background-color:#eee>}</span> <span style=background-color:#eee>${</span><span style=color:#963>logfile</span><span style=background-color:#eee>}</span>.old 2&gt;&amp;<span style=color:#60e;font-weight:700>1</span> &amp;&gt;/dev/null

    <span style=color:#888>#start program now</span>
    pkill -9 -f <span style=background-color:#eee>${</span><span style=color:#963>SUPERVISE_NAME</span><span style=background-color:#eee>}</span>

    <span style=color:#888># 调用supervise 功能</span>
    <span style=color:#333>(</span>setsid ./bin/<span style=background-color:#eee>${</span><span style=color:#963>SUPERVISE_NAME</span><span style=background-color:#eee>}</span> &gt;/dev/null 2&gt;&amp;<span style=color:#60e;font-weight:700>1</span> &amp;<span style=color:#333>)</span>
    sleep 3s

    check_running
    <span style=color:#080;font-weight:700>if</span> <span style=color:#333>[</span> <span style=color:#963>$?</span> -gt <span style=color:#60e;font-weight:700>0</span> <span style=color:#333>]</span>;<span style=color:#080;font-weight:700>then</span>
        <span style=color:#963>pid</span><span style=color:#333>=</span><span style=background-color:#fff0f0>`</span>pgrep -f <span style=background-color:#fff0f0>&#34;</span><span style=background-color:#eee>${</span><span style=color:#963>app</span><span style=background-color:#eee>}</span><span style=background-color:#fff0f0>&#34;</span> | sort -nr | head -n1<span style=background-color:#fff0f0>`</span>

        <span style=color:#007020>echo</span> <span style=background-color:#fff0f0>&#34;</span><span style=background-color:#eee>${</span><span style=color:#963>app</span><span style=background-color:#eee>}</span><span style=background-color:#fff0f0> started. pid = </span><span style=background-color:#eee>${</span><span style=color:#963>pid</span><span style=background-color:#eee>}</span><span style=background-color:#fff0f0>&#34;</span>
    <span style=color:#080;font-weight:700>else</span>
        <span style=color:#007020>echo</span> <span style=background-color:#fff0f0>&#34;</span><span style=background-color:#eee>${</span><span style=color:#963>app</span><span style=background-color:#eee>}</span><span style=background-color:#fff0f0> failed to start.&#34;</span>
        pkill -9 -f <span style=background-color:#eee>${</span><span style=color:#963>SUPERVISE_NAME</span><span style=background-color:#eee>}</span>

        <span style=color:#080;font-weight:700>return</span> <span style=color:#60e;font-weight:700>1</span>
    <span style=color:#080;font-weight:700>fi</span>
<span style=color:#333>}</span>

<span style=color:#080;font-weight:700>function</span> stop<span style=color:#333>(){</span>
    pkill -9 -f <span style=background-color:#eee>${</span><span style=color:#963>SUPERVISE_NAME</span><span style=background-color:#eee>}</span>

    pkill -f <span style=background-color:#fff0f0>&#34;</span><span style=background-color:#eee>${</span><span style=color:#963>app</span><span style=background-color:#eee>}</span><span style=background-color:#fff0f0>&#34;</span> &gt; /dev/null 2&gt;&amp;<span style=color:#60e;font-weight:700>1</span>
    sleep 3s

    <span style=color:#080;font-weight:700>for</span> i in <span style=color:#333>{</span>1..5<span style=color:#333>}</span>
    <span style=color:#080;font-weight:700>do</span>
        check_running
        <span style=color:#080;font-weight:700>if</span> <span style=color:#333>[</span> <span style=color:#963>$?</span> -gt <span style=color:#60e;font-weight:700>0</span> <span style=color:#333>]</span>; <span style=color:#080;font-weight:700>then</span>
            sleep 1s
            <span style=color:#080;font-weight:700>continue</span>
        <span style=color:#080;font-weight:700>fi</span>
    <span style=color:#080;font-weight:700>done</span>

    check_running
    <span style=color:#080;font-weight:700>if</span> <span style=color:#333>[</span> <span style=color:#963>$?</span> -eq <span style=color:#60e;font-weight:700>0</span> <span style=color:#333>]</span>;<span style=color:#080;font-weight:700>then</span>
        <span style=color:#007020>echo</span> <span style=background-color:#fff0f0>&#34;</span><span style=background-color:#eee>${</span><span style=color:#963>app</span><span style=background-color:#eee>}</span><span style=background-color:#fff0f0> stopped.&#34;</span>
        <span style=color:#080;font-weight:700>return</span> <span style=color:#60e;font-weight:700>0</span>
    <span style=color:#080;font-weight:700>else</span>
        <span style=color:#007020>echo</span> <span style=background-color:#fff0f0>&#34;</span><span style=background-color:#eee>${</span><span style=color:#963>app</span><span style=background-color:#eee>}</span><span style=background-color:#fff0f0> failed to stop.&#34;</span>
        <span style=color:#080;font-weight:700>return</span> <span style=color:#60e;font-weight:700>1</span>
    <span style=color:#080;font-weight:700>fi</span>
<span style=color:#333>}</span>

<span style=color:#080;font-weight:700>function</span> restart<span style=color:#333>(){</span>
    shutdown
    start
<span style=color:#333>}</span>

<span style=color:#080;font-weight:700>function</span> shutdown<span style=color:#333>(){</span>
    pkill -9 -f <span style=background-color:#eee>${</span><span style=color:#963>SUPERVISE_NAME</span><span style=background-color:#eee>}</span>

    pkill -9 -f <span style=background-color:#fff0f0>&#34;</span><span style=background-color:#eee>${</span><span style=color:#963>app</span><span style=background-color:#eee>}</span><span style=background-color:#fff0f0>&#34;</span> &gt; /dev/null 2&gt;&amp;<span style=color:#60e;font-weight:700>1</span>
    sleep 3s

    check_running
    <span style=color:#080;font-weight:700>if</span> <span style=color:#333>[</span> <span style=color:#963>$?</span> -eq <span style=color:#60e;font-weight:700>0</span> <span style=color:#333>]</span>;<span style=color:#080;font-weight:700>then</span>
        <span style=color:#007020>echo</span> <span style=background-color:#fff0f0>&#34;</span><span style=background-color:#eee>${</span><span style=color:#963>app</span><span style=background-color:#eee>}</span><span style=background-color:#fff0f0> shutdown.&#34;</span>
        <span style=color:#080;font-weight:700>return</span> <span style=color:#60e;font-weight:700>0</span>
    <span style=color:#080;font-weight:700>else</span>
        <span style=color:#007020>echo</span> <span style=background-color:#fff0f0>&#34;</span><span style=background-color:#eee>${</span><span style=color:#963>app</span><span style=background-color:#eee>}</span><span style=background-color:#fff0f0> failed to shutdown.&#34;</span>
        <span style=color:#080;font-weight:700>return</span> <span style=color:#60e;font-weight:700>1</span>
    <span style=color:#080;font-weight:700>fi</span>
<span style=color:#333>}</span>

<span style=color:#888># for ifrit use</span>
<span style=color:#888># no pids printed</span>
<span style=color:#080;font-weight:700>function</span> status<span style=color:#333>(){</span>
    check_running
    <span style=color:#080;font-weight:700>if</span> <span style=color:#333>[</span> <span style=color:#963>$?</span> -gt <span style=color:#60e;font-weight:700>0</span> <span style=color:#333>]</span>;<span style=color:#080;font-weight:700>then</span>
        <span style=color:#080;font-weight:700>return</span> <span style=color:#60e;font-weight:700>0</span>
    <span style=color:#080;font-weight:700>else</span>
        <span style=color:#080;font-weight:700>return</span> <span style=color:#60e;font-weight:700>1</span>
    <span style=color:#080;font-weight:700>fi</span>
<span style=color:#333>}</span>

<span style=color:#888># for manual use</span>
<span style=color:#080;font-weight:700>function</span> check<span style=color:#333>(){</span>
    check_running
    <span style=color:#080;font-weight:700>if</span> <span style=color:#333>[</span> <span style=color:#963>$?</span> -gt <span style=color:#60e;font-weight:700>0</span> <span style=color:#333>]</span>;<span style=color:#080;font-weight:700>then</span>
        <span style=color:#963>pid</span><span style=color:#333>=</span><span style=background-color:#fff0f0>`</span>pgrep -f <span style=background-color:#fff0f0>&#34;</span><span style=background-color:#eee>${</span><span style=color:#963>app</span><span style=background-color:#eee>}</span><span style=background-color:#fff0f0>&#34;</span><span style=background-color:#fff0f0>`</span>

        <span style=color:#007020>echo</span> <span style=background-color:#fff0f0>&#34;running, pid = </span><span style=background-color:#eee>${</span><span style=color:#963>pid</span><span style=background-color:#eee>}</span><span style=background-color:#fff0f0>&#34;</span>
        <span style=color:#080;font-weight:700>return</span> <span style=color:#60e;font-weight:700>0</span>
    <span style=color:#080;font-weight:700>else</span>
        <span style=color:#007020>echo</span> <span style=background-color:#fff0f0>&#34;not running&#34;</span>
        <span style=color:#080;font-weight:700>return</span> <span style=color:#60e;font-weight:700>1</span>
    <span style=color:#080;font-weight:700>fi</span>
<span style=color:#333>}</span>

<span style=color:#080;font-weight:700>function</span> help<span style=color:#333>(){</span>
    <span style=color:#007020>echo</span> <span style=background-color:#fff0f0>&#34;</span><span style=color:#963>$0</span><span style=background-color:#fff0f0> start|stop|restart|shutdown|status|check&#34;</span>
<span style=color:#333>}</span>

<span style=color:#080;font-weight:700>function</span> main<span style=color:#333>()</span> <span style=color:#333>{</span>
    <span style=color:#080;font-weight:700>case</span> <span style=color:#963>$1</span> in
        start|stop|restart|shutdown|status|check|<span style=color:#007020>help</span><span style=color:#333>)</span>
            <span style=color:#963>$1</span>
            <span style=color:#007020>exit</span> <span style=color:#963>$?</span>
            ;;
        *<span style=color:#333>)</span>
            <span style=color:#007020>help</span>
            <span style=color:#007020>exit</span> <span style=color:#60e;font-weight:700>1</span>
            ;;
    <span style=color:#080;font-weight:700>esac</span>
<span style=color:#333>}</span>

main <span style=color:#963>$@</span>

</code></pre></div><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#579>#!/bin/bash
</span><span style=color:#579></span><span style=color:#888># supervise.server</span>
<span style=color:#888># qudongfang@gmail.com</span>

<span style=color:#963>PATH</span><span style=color:#333>=</span>/usr/sbin:/sbin:/usr/bin:/bin
<span style=color:#963>IFS</span><span style=color:#333>=</span>

<span style=color:#007020>readonly</span> <span style=color:#963>logfile</span><span style=color:#333>=</span><span style=background-color:#fff0f0>&#34;./log/stdout.log&#34;</span>

<span style=color:#963>NICE_PREFIX</span><span style=color:#333>=</span><span style=background-color:#fff0f0>&#34;&#34;</span>
<span style=color:#007020>type</span> nice &gt;/dev/null <span style=color:#333>&amp;&amp;</span> <span style=color:#963>NICE_PREFIX</span><span style=color:#333>=</span><span style=background-color:#fff0f0>&#34;nice -n 19&#34;</span>

run<span style=color:#333>()</span> <span style=color:#333>{</span>
    <span style=color:#080;font-weight:700>while</span> <span style=color:#007020>true</span>
    <span style=color:#080;font-weight:700>do</span>
        <span style=color:#888># 构造启动命令行</span>
        <span style=color:#963>cmd</span><span style=color:#333>=</span><span style=background-color:#fff0f0>&#34;</span><span style=background-color:#eee>${</span><span style=color:#963>NICE_PREFIX</span><span style=background-color:#eee>}</span><span style=background-color:#fff0f0> ./bin/server &amp;&gt;&gt; </span><span style=background-color:#eee>${</span><span style=color:#963>logfile</span><span style=background-color:#eee>}</span><span style=background-color:#fff0f0> 2&gt;&amp;1&#34;</span>

        <span style=color:#888># 记录启动命令</span>
        <span style=color:#007020>echo</span> <span style=background-color:#eee>${</span><span style=color:#963>cmd</span><span style=background-color:#eee>}</span> &gt;&gt; <span style=background-color:#eee>${</span><span style=color:#963>logfile</span><span style=background-color:#eee>}</span>

        <span style=color:#888># 执行启动</span>
        <span style=color:#007020>eval</span> <span style=background-color:#fff0f0>&#34;</span><span style=background-color:#eee>${</span><span style=color:#963>cmd</span><span style=background-color:#eee>}</span><span style=background-color:#fff0f0>&#34;</span>

        <span style=color:#888># sleep 10s 后重启</span>
        sleep 10s

        <span style=color:#888># 记录重启时间</span>
        <span style=color:#007020>echo</span> <span style=background-color:#fff0f0>&#34;`date`: server restarted&#34;</span> &gt;&gt; <span style=background-color:#eee>${</span><span style=color:#963>logfile</span><span style=background-color:#eee>}</span>
    <span style=color:#080;font-weight:700>done</span>
<span style=color:#333>}</span>

<span style=color:#080;font-weight:700>if</span> <span style=color:#333>[</span> <span style=color:#963>$#</span> -eq <span style=color:#60e;font-weight:700>1</span> <span style=color:#333>]</span>; <span style=color:#080;font-weight:700>then</span>
    <span style=color:#080;font-weight:700>if</span> <span style=color:#333>[</span> x<span style=background-color:#fff0f0>&#34;</span><span style=background-color:#eee>${</span><span style=color:#963>1</span><span style=background-color:#eee>}</span><span style=background-color:#fff0f0>&#34;</span> <span style=color:#333>=</span> x<span style=background-color:#fff0f0>&#34;--run&#34;</span> <span style=color:#333>]</span>; <span style=color:#080;font-weight:700>then</span>
        run
    <span style=color:#080;font-weight:700>fi</span>
<span style=color:#080;font-weight:700>fi</span>

<span style=color:#007020>exec</span> setsid <span style=background-color:#fff0f0>&#34;</span><span style=background-color:#eee>${</span><span style=color:#963>0</span><span style=background-color:#eee>}</span><span style=background-color:#fff0f0>&#34;</span> --run &lt;/dev/null &gt;/dev/null 2&gt;&amp;<span style=color:#60e;font-weight:700>1</span>
<span style=color:#007020>exit</span> <span style=color:#60e;font-weight:700>1</span>

</code></pre></div></div><div class=tags><div class=taxosfloating_left><p>Categories</p></div><div class=termsfloating_right><p><a href=/categories/bash/>bash</a>
<a href=/categories/ops/>ops</a></p></div><div class=clearit></div><div class=tags><div class=taxosfloating_left><p>Tags</p></div><div class=termsfloating_right><p><a href=/tags/bash/>bash</a>
<a href=/tags/ops/>ops</a></p></div><div class=clearit></div></div></div></main><footer>©Copyright | <a href=https://github.com/qudongfang/>Concurrent work</a></footer></body></html>