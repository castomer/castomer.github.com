<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.82.0"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta property="og:title" content="golang server graceful shutdown"><meta name=author content="Dongfang Qu"><meta name=keywords content="linux,SRE,golang,python"><meta name=description content="实现go语言serverd的优雅退出。
 package main // demo.go // qudongfang@gmail.com  import ( log &#34;github.com/cihub/seelog&#34; &#34;os&#34; &#34;os/signal&#34; &#34;syscall&#34; …"><meta property="og:title" content="golang server graceful shutdown"><meta property="og:description" content="实现go语言serverd的优雅退出。
 package main // demo.go // qudongfang@gmail.com  import ( log &#34;github.com/cihub/seelog&#34; &#34;os&#34; &#34;os/signal&#34; &#34;syscall&#34; &#34;time&#34; ) func addShutDownHook(functions ...func()) { signals := make(chan os.Signal, 1) signal.Notify(signals, syscall.SIGINT, syscall.SIGTERM, syscall.SIGQUIT) go func() { for { s := <-signals switch s { case syscall.SIGINT, syscall.SIGTERM, syscall.SIGQUIT: log.Trace(&#34;got shutdown signal. &#34;, s) for _, f := range functions { f() } log.Trace(&#34;shutdown now&#34;) log.Flush() os.Exit(0) } } }() } func main() { // TODO add your code here  // add shutdown hooks 	addShutDownHook(func() { log."><meta property="og:type" content="article"><meta property="og:url" content="https://www.concurrent.work/2016/12/18/golang-server-graceful-shutdown/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-12-18T00:00:00+00:00"><meta property="article:modified_time" content="2016-12-18T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="golang server graceful shutdown"><meta name=twitter:description content="实现go语言serverd的优雅退出。
 package main // demo.go // qudongfang@gmail.com  import ( log &#34;github.com/cihub/seelog&#34; &#34;os&#34; &#34;os/signal&#34; &#34;syscall&#34; &#34;time&#34; ) func addShutDownHook(functions ...func()) { signals := make(chan os.Signal, 1) signal.Notify(signals, syscall.SIGINT, syscall.SIGTERM, syscall.SIGQUIT) go func() { for { s := <-signals switch s { case syscall.SIGINT, syscall.SIGTERM, syscall.SIGQUIT: log.Trace(&#34;got shutdown signal. &#34;, s) for _, f := range functions { f() } log.Trace(&#34;shutdown now&#34;) log.Flush() os.Exit(0) } } }() } func main() { // TODO add your code here  // add shutdown hooks 	addShutDownHook(func() { log."><link rel=stylesheet type=text/css media=screen href=/css/normalize.css><link rel=stylesheet type=text/css media=screen href=/css/main.css><link rel=stylesheet type=text/css media=screen href=/css/all.css><link rel=stylesheet href=/css/katex.min.css crossorigin=anonymous><script defer src=/js/katex.min.js integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz crossorigin=anonymous></script><script defer src=/js/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><title>golang server graceful shutdown | Concurrent Work</title></head><body><header><div id=titletext><h2 id=title><a href=https://www.concurrent.work>Concurrent Work</a></h2></div><div id=title-description><p id=subtitle>Rambling of a coder who craves for knowledge and understanding of the world.</p><div id=social><nav><ul><li><a href=https://github.com/qudongfang><i title=Github class="icons fab fa-github"></i></a></li><li><a href=https://www.linkedin.com/in/qudongfang/><i title=LinkedIn class="icons fab fa-linkedin"></i></a></li><li><a href=https://twitter.com/qudongfang><i title=Twitter class="icons fab fa-twitter"></i></a></li></ul></nav></div></div><div id=mainmenu><nav><ul><li><a href=/posts>All Posts</a></li><li><a href=/tags>Tags</a></li><li><a href=/about>About</a></li></ul></nav></div></header><main><div class=post><div class=author><p>Written by Dongfang Qu</p></div><div class=post-header><div class=meta><div class=date><span class=day>18</span>
<span class=rest>Dec 2016</span></div></div><div class=matter><h1 class=title>golang server graceful shutdown</h1></div></div><div class=markdown><p>实现go语言serverd的优雅退出。</p><hr><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#080;font-weight:700>package</span> main

<span style=color:#888>// demo.go
</span><span style=color:#888>// qudongfang@gmail.com
</span><span style=color:#888></span>
<span style=color:#080;font-weight:700>import</span> (
	log <span style=background-color:#fff0f0>&#34;github.com/cihub/seelog&#34;</span>
	<span style=background-color:#fff0f0>&#34;os&#34;</span>
	<span style=background-color:#fff0f0>&#34;os/signal&#34;</span>
	<span style=background-color:#fff0f0>&#34;syscall&#34;</span>
	<span style=background-color:#fff0f0>&#34;time&#34;</span>
)

<span style=color:#080;font-weight:700>func</span> <span style=color:#06b;font-weight:700>addShutDownHook</span>(functions <span style=color:#333>...</span><span style=color:#080;font-weight:700>func</span>()) {
	signals <span style=color:#333>:=</span> <span style=color:#007020>make</span>(<span style=color:#080;font-weight:700>chan</span> os.Signal, <span style=color:#00d;font-weight:700>1</span>)
	signal.<span style=color:#06b;font-weight:700>Notify</span>(signals, syscall.SIGINT, syscall.SIGTERM, syscall.SIGQUIT)
	<span style=color:#080;font-weight:700>go</span> <span style=color:#080;font-weight:700>func</span>() {
		<span style=color:#080;font-weight:700>for</span> {
			s <span style=color:#333>:=</span> <span style=color:#333>&lt;-</span>signals
			<span style=color:#080;font-weight:700>switch</span> s {
			<span style=color:#080;font-weight:700>case</span> syscall.SIGINT, syscall.SIGTERM, syscall.SIGQUIT:
				log.<span style=color:#06b;font-weight:700>Trace</span>(<span style=background-color:#fff0f0>&#34;got shutdown signal. &#34;</span>, s)

				<span style=color:#080;font-weight:700>for</span> _, f <span style=color:#333>:=</span> <span style=color:#080;font-weight:700>range</span> functions {
					<span style=color:#06b;font-weight:700>f</span>()
				}

				log.<span style=color:#06b;font-weight:700>Trace</span>(<span style=background-color:#fff0f0>&#34;shutdown now&#34;</span>)
				log.<span style=color:#06b;font-weight:700>Flush</span>()

				os.<span style=color:#06b;font-weight:700>Exit</span>(<span style=color:#00d;font-weight:700>0</span>)
			}
		}
	}()
}

<span style=color:#080;font-weight:700>func</span> <span style=color:#06b;font-weight:700>main</span>() {
	<span style=color:#888>// TODO add your code here
</span><span style=color:#888></span>
	<span style=color:#888>// add shutdown hooks
</span><span style=color:#888></span>	<span style=color:#06b;font-weight:700>addShutDownHook</span>(<span style=color:#080;font-weight:700>func</span>() {
		log.<span style=color:#06b;font-weight:700>Info</span>(<span style=background-color:#fff0f0>&#34;exec shutdown hook: begin&#34;</span>)

		<span style=color:#888>// TODO add your code here
</span><span style=color:#888></span>
		time.<span style=color:#06b;font-weight:700>Sleep</span>(time.Second <span style=color:#333>*</span> <span style=color:#00d;font-weight:700>3</span>)

		log.<span style=color:#06b;font-weight:700>Info</span>(<span style=background-color:#fff0f0>&#34;exit now.&#34;</span>)

		log.<span style=color:#06b;font-weight:700>Flush</span>()
	})

	log.<span style=color:#06b;font-weight:700>Info</span>(<span style=background-color:#fff0f0>&#34;program has started successfully.&#34;</span>)

	<span style=color:#080;font-weight:700>select</span> {}
}

</code></pre></div></div></div></div></main><footer>©Copyright | <a href=https://github.com/qudongfang/>Concurrent work</a></footer></body></html>